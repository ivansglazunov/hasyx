"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2567],{12567:(e,t,a)=>{a.r(t),a.d(t,{HasyxConfigForm:()=>f,default:()=>p});var s=a(95155),l=a(12115),n=a(50629),i=a(33640),r=a(97168),o=a(88482),c=a(95784),d=a(88893);async function u(){let e=await fetch("/api/config",{cache:"no-store"});if(!e.ok)throw Error("Failed to load config");let t=await e.json();return{config:(null==t?void 0:t.config)||{},schema:null==t?void 0:t.schema,ui:null==t?void 0:t.ui}}async function m(e){let t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({config:e})});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error((null==e?void 0:e.error)?JSON.stringify(e.error):"Failed to save config")}}function f(){let e=(0,d.c3)("config"),[t,a]=(0,l.useState)(null),[f,p]=(0,l.useState)(null),[x,h]=(0,l.useState)(null),[v,g]=(0,l.useState)(!1),[j,y]=(0,l.useState)(null),[b,k]=(0,l.useState)(!1),[N,w]=(0,l.useState)(null),[C,S]=(0,l.useState)({name:"root"}),z=(0,l.useMemo)(()=>({"ui:submitButtonOptions":{norender:!0}}),[]),A=(0,l.useCallback)(async()=>{y(null);try{let e=await u();console.log("[HasyxConfigForm] schema (server):",e.schema),a(e.config),h(e.config),p(e.schema),w(e.ui||null)}catch(e){y((null==e?void 0:e.message)||String(e))}},[]);(0,l.useEffect)(()=>{A()},[A]);let F=(0,l.useCallback)(async e=>{g(!0),y(null);try{let t=function(e,t){if(!t||!t.properties)return e;let a=function(e,t){let a={},s=t&&t.properties||{},l={...e};for(let e of(l.telegram&&!l.telegramBot&&(l.telegramBot=l.telegram,delete l.telegram),Object.keys(s))){let t=s[e],i=t&&"object"===t.type&&!!t.additionalProperties;if(void 0!==l[e])a[e]=l[e];else if(i)a[e]={};else if("variant"===e){var n;a[e]=null!=(n=l[e])?n:""}else a[e]=l[e]}return a}(e,t);for(let[e,s]of Object.entries(t.properties)){let l=a[e];if(!l)continue;let n=s.additionalProperties,i=function(e,t){if(!t)return t;if(t.$ref&&"string"==typeof t.$ref){let a=t.$ref.replace(/^#\//,"").split("/"),s=e;for(let e of a)s&&"object"==typeof s&&(s=s[e]);return s||t}return t}(t,n);if("object"===s.type&&i&&"object"==typeof i){let t=Array.isArray(i.required)?i.required:[];t&&0!==t.length||(t=function(e){var t,a;return((null==N||null==(a=N.sections)||null==(t=a.find(t=>t.key===e))?void 0:t.fields)||[]).filter(e=>e.isRequired).map(e=>e.key)}(e)),0===t.length&&i.properties&&i.properties;let s={};for(let[e,a]of Object.entries(l))a&&"object"==typeof a&&(t.every(e=>void 0!==a[e]&&null!==a[e]&&""!==a[e])||0===t.length)&&(s[e]=a);a[e]=s}}return a}(e,f);await m(t),a(t),h(t)}catch(e){y((null==e?void 0:e.message)||String(e))}finally{g(!1)}},[]);(0,l.useEffect)(()=>{if(!b||!x)return;let e=setTimeout(()=>{F(x)},500);return()=>clearTimeout(e)},[b,x,F]);let _=e=>{let t=x[e];return t&&"object"==typeof t?Object.keys(t).length:Array.isArray(t)?t.length:+!!t},O=(0,l.useMemo)(()=>(null==N?void 0:N.sections)||[],[N]),T=(0,l.useCallback)(e=>{h(e),k(!0)},[]);if(!t||!f||!x)return(0,s.jsx)("div",{style:{padding:16},children:e("loading")});let V=(t,a)=>{var l,c,d;let u=null==f||null==(l=f.properties)?void 0:l[t],m=null==N||null==(d=N.sections)||null==(c=d.find(e=>e.key===t))?void 0:c.fields,p=(null==u?void 0:u.additionalProperties)||{type:"object"};if(Array.isArray(m)&&m.length>0){let e={},t=[];for(let a of m){let s={};s="boolean"===a.kind?{type:"boolean"}:"number"===a.kind?{type:"number"}:"reference"===a.kind?{type:"string",enum:Object.keys(x[a.referenceKey||""]||{})}:{type:"string"},Array.isArray(a.enumValues)&&a.enumValues.length>0&&(s.enum=a.enumValues),void 0!==a.defaultValue&&(s.default=a.defaultValue),e[a.key]=s,a.isRequired&&t.push(a.key)}p={type:"object",properties:e,additionalProperties:!1},t.length>0&&(p.required=t)}let h=f&&(f.definitions||f.$defs)||void 0,v=h?{...p,definitions:h}:p,g=(x[t]||{})[a]||{};return(0,s.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(r.$,{variant:"outline",onClick:()=>S({name:"keys",sectionKey:t}),children:e("back")}),(0,s.jsxs)("div",{className:"text-xl font-semibold",children:[t," / ",a]})]}),(0,s.jsx)(o.Zp,{children:(0,s.jsx)(o.Wu,{className:"pt-6",children:(0,s.jsx)(n.Ay,{schema:v,formData:g,validator:i.Ay,uiSchema:z,liveValidate:!0,showErrorList:!1,templates:{TitleFieldTemplate:()=>null,DescriptionFieldTemplate:()=>null},onChange:e=>{let s=e.formData,l={...x};l[t]={...l[t]||{},[a]:s},T(l)},onError:t=>y(e("validationErrors",{count:t.length}))})})})]})},$="keyForm"===C.name&&"variants"===C.sectionKey?{name:"variantForm",keyName:C.keyName}:C;return(0,s.jsxs)("div",{className:"flex flex-col gap-3",children:["root"===$.name&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:[(0,s.jsx)(o.Zp,{className:"cursor-pointer",onClick:()=>S({name:"variant"}),children:(0,s.jsxs)(o.aR,{children:[(0,s.jsx)(o.ZB,{children:e("variant")}),(0,s.jsx)(o.BT,{children:(()=>{let e=x.variant,t=x.variants||{};if(e&&t[e]){let a=t[e],s=(null==a?void 0:a.host)||"no host",l=(null==a?void 0:a.hasura)||"no hasura";return"".concat(e,": ").concat(s," -> ").concat(l)}return String(e||"not set")})()})]})}),O.filter(e=>"keys"===e.type).map(t=>(0,s.jsx)(o.Zp,{className:"cursor-pointer",onClick:()=>S({name:"keys",sectionKey:t.key}),children:(0,s.jsxs)(o.aR,{children:[(0,s.jsx)(o.ZB,{children:t.key}),(0,s.jsx)(o.BT,{children:e("items",{count:_(t.key)})})]})},t.key))]}),"variant"===$.name&&(()=>{let t=Object.keys(x.variants||{});return(0,s.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(r.$,{variant:"outline",onClick:()=>S({name:"root"}),children:e("back")}),(0,s.jsx)("div",{className:"text-xl font-semibold",children:e("selectVariant")})]}),(0,s.jsx)("div",{className:"max-w-sm",children:(0,s.jsxs)(c.l6,{value:x.variant||"",onValueChange:e=>{T({...x,variant:e})},children:[(0,s.jsx)(c.bq,{className:"w-full",children:(0,s.jsx)(c.yv,{placeholder:e("pickVariant")})}),(0,s.jsx)(c.gC,{children:t.map(e=>(0,s.jsx)(c.eb,{value:e,children:e},e))})]})})]})})(),"keys"===$.name&&(t=>{let a=Object.keys(x[t]||{}),l=e=>{let a={...x},{[e]:s,...l}=a[t]||{};a[t]=l,T(a)};return(0,s.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(r.$,{variant:"outline",onClick:()=>S({name:"root"}),children:e("back")}),(0,s.jsx)("div",{className:"text-xl font-semibold",children:t}),(0,s.jsx)("div",{className:"ml-auto",children:(0,s.jsx)(r.$,{onClick:()=>{let e=prompt("New ".concat(t," key name"));if(!e)return;let a={...x};a[t]={...a[t]||{},[e]:{}},T(a)},children:e("add")})})]}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:a.map(a=>(0,s.jsx)(o.Zp,{children:(0,s.jsxs)(o.aR,{className:"flex flex-row items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(o.ZB,{className:"text-base",children:a}),(0,s.jsx)(o.BT,{children:e("editSection",{section:t})})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(r.$,{variant:"outline",onClick:()=>S({name:"keyForm",sectionKey:t,keyName:a}),children:e("open")}),(0,s.jsx)(r.$,{variant:"destructive",onClick:()=>l(a),children:e("delete")})]})]})},a))})]})})($.sectionKey),"keyForm"===$.name&&V($.sectionKey,$.keyName),"variantForm"===$.name&&V("variants",$.keyName),(0,s.jsxs)("div",{className:"text-sm text-muted-foreground min-h-5",children:[v&&(0,s.jsx)("span",{children:e("saving")}),!v&&b&&!j&&(0,s.jsx)("span",{children:e("changesSaved")})]}),j&&(0,s.jsx)("div",{className:"text-red-500 text-sm",children:j})]})}let p=f},95784:(e,t,a)=>{a.d(t,{bq:()=>u,eb:()=>f,gC:()=>m,l6:()=>c,yv:()=>d});var s=a(95155);a(12115);var l=a(31992),n=a(66474),i=a(5196),r=a(47863),o=a(53999);function c(e){let{...t}=e;return(0,s.jsx)(l.bL,{"data-slot":"select",...t})}function d(e){let{...t}=e;return(0,s.jsx)(l.WT,{"data-slot":"select-value",...t})}function u(e){let{className:t,size:a="default",children:i,...r}=e;return(0,s.jsxs)(l.l9,{"data-slot":"select-trigger","data-size":a,className:(0,o.cn)("border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",t),...r,children:[i,(0,s.jsx)(l.In,{asChild:!0,children:(0,s.jsx)(n.A,{className:"size-4 opacity-50"})})]})}function m(e){let{className:t,children:a,position:n="popper",...i}=e;return(0,s.jsx)(l.ZL,{children:(0,s.jsxs)(l.UC,{"data-slot":"select-content",className:(0,o.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md","popper"===n&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:n,...i,children:[(0,s.jsx)(p,{}),(0,s.jsx)(l.LM,{className:(0,o.cn)("p-1","popper"===n&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"),children:a}),(0,s.jsx)(x,{})]})})}function f(e){let{className:t,children:a,...n}=e;return(0,s.jsxs)(l.q7,{"data-slot":"select-item",className:(0,o.cn)("focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",t),...n,children:[(0,s.jsx)("span",{className:"absolute right-2 flex size-3.5 items-center justify-center",children:(0,s.jsx)(l.VF,{children:(0,s.jsx)(i.A,{className:"size-4"})})}),(0,s.jsx)(l.p4,{children:a})]})}function p(e){let{className:t,...a}=e;return(0,s.jsx)(l.PP,{"data-slot":"select-scroll-up-button",className:(0,o.cn)("flex cursor-default items-center justify-center py-1",t),...a,children:(0,s.jsx)(r.A,{className:"size-4"})})}function x(e){let{className:t,...a}=e;return(0,s.jsx)(l.wn,{"data-slot":"select-scroll-down-button",className:(0,o.cn)("flex cursor-default items-center justify-center py-1",t),...a,children:(0,s.jsx)(n.A,{className:"size-4"})})}}}]);