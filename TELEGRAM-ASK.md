# Telegram Ask Integration

Telegram Ask Integration –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Hasyx AI —á–µ—Ä–µ–∑ Telegram bot —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤.

## Features

- **ü§ñ AI Assistant —á–µ—Ä–µ–∑ Telegram**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π AI –ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram –±–æ—Ç–µ
- **‚ö° Real-time Streaming**: –û—Ç–≤–µ—Ç—ã AI –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **üòà Code Execution**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ JavaScript, TypeScript –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ Telegram
- **üìä Instance Management**: –£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ AI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- **üíæ Memory Management**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- **üõ°Ô∏è Error Handling**: Graceful –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- **üì± Message Buffering**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
- **üîß Configurable**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## Architecture

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **`AskHasyx`** (–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å) - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π AI —Å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –≤—ã–≤–æ–¥–∞
2. **`TelegramAskWrapper`** - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram  
3. **Instance Manager** - –ú–µ–Ω–µ–¥–∂–µ—Ä —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
4. **Output Handlers** - –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤—ã–≤–æ–¥–∞

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```
User Message (Telegram) 
    ‚Üì
Telegram Bot API 
    ‚Üì  
handleStartEvent() (database operations)
    ‚Üì
route.ts (response generation)
    ‚Üì
defineTelegramAsk() (get/create AI instance)
    ‚Üì
TelegramAskWrapper.ask() (AI processing)
    ‚Üì
Output Handlers (send to Telegram)
    ‚Üì
Telegram Bot API ‚Üí User
```

## Quick Start

### 1. Environment Setup (via configurator)

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `npx hasyx config`. –§–∞–π–ª `.env` –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞–Ω—ã:
- `TELEGRAM_BOT_TOKEN`
- `OPENROUTER_API_KEY`
- `NEXT_PUBLIC_HASURA_GRAPHQL_URL`
- `HASURA_ADMIN_SECRET`

### 2. Basic Integration in route.ts

```typescript
import { NextResponse } from 'next/server';
import { handleStartEvent, TelegramUpdate } from 'hasyx/lib/telegram-bot';
import { defineTelegramAsk } from 'hasyx/lib/ask-telegram';

export async function POST(request: Request) {
  const payload = (await request.json()) as TelegramUpdate;
  
  // Handle /start and database operations
  const result = await handleStartEvent(payload, adminClient);
  
  if (result.success && result.chatId && result.userId && payload.message?.text) {
    if (payload.message.text.trim().toLowerCase() !== '/start') {
      // Get AI instance for this user
      const askInstance = defineTelegramAsk(
        result.userId,
        result.chatId,
        process.env.TELEGRAM_BOT_TOKEN!,
        process.env.OPENROUTER_API_KEY!,
        'My Project'
      );

      // Process with AI (responses sent automatically to Telegram)
      await askInstance.ask(payload.message.text);
    }
  }
  
  return NextResponse.json(result);
}
```

### 3. Testing

1. Create Telegram bot via [@BotFather](https://t.me/BotFather)
2. Set webhook: `https://your-app.com/api/telegram_bot`
3. Send `/start` to your bot
4. Ask any question: "Calculate 5 factorial with code"

## API Reference

### `defineTelegramAsk()`

–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä AI –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```typescript
function defineTelegramAsk(
  userId: number,          // Telegram user ID
  chatId: number,          // Telegram chat ID  
  botToken: string,        // Telegram bot token
  openRouterToken: string, // OpenRouter API key
  projectName?: string,    // Project name for system prompt
  askOptions?: TelegramAskOptions // Additional options
): TelegramAskWrapper
```

### `TelegramAskOptions`

```typescript
interface TelegramAskOptions extends AskOptions {
  telegram?: {
    botToken: string;
    chatId: number;
    bufferTime?: number;         // Buffer timeout (default: 1000ms)
    maxMessageLength?: number;   // Max Telegram message length (default: 4096)
    enableCodeBlocks?: boolean;  // Format code blocks (default: true)
  };
}
```

### `TelegramAskWrapper`

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI —á–µ—Ä–µ–∑ Telegram.

```typescript
class TelegramAskWrapper extends AskHasyx {
  async ask(question: string): Promise<string>
  async flush(): Promise<void>
}
```

### Instance Management

```typescript
// Get statistics about active instances
const stats = getTelegramAskStats();
console.log(`Active instances: ${stats.totalInstances}`);

// Cleanup all instances (useful for testing)
clearAllTelegramAskInstances();
```

## Advanced Usage

### Custom Ask Options

```typescript
const askInstance = defineTelegramAsk(
  userId,
  chatId,
  botToken,
  openRouterToken,
  'Advanced Project',
  {
    exec: true,      // Enable JavaScript
    execTs: false,   // Disable TypeScript
    terminal: true,  // Enable terminal
    telegram: {
      botToken,
      chatId,
      bufferTime: 500,        // Faster responses
      maxMessageLength: 2000, // Shorter messages
      enableCodeBlocks: false // Disable code formatting
    }
  }
);
```

### Manual AskHasyx Creation with Custom Handlers

```typescript
import { AskHasyx, OutputHandlers } from 'hasyx/lib/ask-hasyx';
import { sendTelegramMessage } from 'hasyx/lib/telegram-bot';

const customHandlers: OutputHandlers = {
  onThinking: () => sendTelegramMessage(botToken, chatId, 'ü§î –î—É–º–∞—é...'),
  onCodeFound: async (code, format) => {
    await sendTelegramMessage(botToken, chatId, `üîç –ù–∞—à–µ–ª ${format} –∫–æ–¥:`);
    await sendTelegramMessage(botToken, chatId, `\`\`\`${format}\n${code}\n\`\`\``);
  },
  onCodeResult: async (result) => {
    await sendTelegramMessage(botToken, chatId, `üí° –†–µ–∑—É–ª—å—Ç–∞—Ç:\n\`\`\`\n${result}\n\`\`\``);
  },
  onError: (error) => sendTelegramMessage(botToken, chatId, `‚ùå –û—à–∏–±–∫–∞: ${error}`)
};

const askInstance = new AskHasyx(
  openRouterToken,
  {
    systemPrompt: 'Custom system prompt',
    askOptions: { exec: true, execTs: true, terminal: true },
    outputHandlers: customHandlers
  }
);
```

## Error Handling

### Automatic Error Handling

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```typescript
// AI execution error
‚ùå –û—à–∏–±–∫–∞: JavaScript execution is disabled

// Network error
‚ùå –û—à–∏–±–∫–∞: Network timeout occurred

// API error  
‚ùå Sorry, there was an error processing your question: Invalid API key
```

### Custom Error Handling

```typescript
try {
  const response = await askInstance.ask(userQuestion);
} catch (error) {
  await sendTelegramMessage(
    botToken,
    chatId,
    `üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`
  );
}
```

## Performance & Optimization

### Instance Lifecycle

- **Creation**: –≠–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Reuse**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
- **Cleanup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (1 —á–∞—Å)
- **Memory**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤

### Message Buffering

```typescript
// Messages are buffered for optimal delivery
onThinking: () => buffer.add('üß† AI –¥—É–º–∞–µ—Ç...')
onCodeFound: (code) => buffer.add(`üìã –ö–æ–¥: ${code}`)
// Buffer flushes every 1000ms or when full
```

### Rate Limiting

```typescript
// Automatic delays between chunked messages
for (const chunk of chunks) {
  await sendTelegramMessage(botToken, chatId, chunk);
  await sleep(100); // Prevent rate limiting
}
```

## Monitoring & Debugging

### Statistics

```typescript
const stats = getTelegramAskStats();
console.log('Active instances:', stats.totalInstances);
console.log('Instances by age:', stats.instancesByAge);
```

### Debug Logging

```bash
DEBUG="hasyx:ask-telegram,hasyx:ask-hasyx" npm start
```

Output:
```
hasyx:ask-telegram Creating new TelegramAsk instance for user 12345, chat 67890
hasyx:ask-hasyx Processing question with beautiful output: What is 2+2?
hasyx:ask-telegram Processing question for chat 67890: What is 2+2?
```

### Health Check

```typescript
// Add to your monitoring
app.get('/health/telegram-ask', (req, res) => {
  const stats = getTelegramAskStats();
  res.json({
    status: 'healthy',
    activeInstances: stats.totalInstances,
    oldestInstance: stats.instancesByAge[0]?.ageMinutes || 0
  });
});
```

## Examples

### Simple Math Bot

```typescript
// User: "Calculate 15 * 27"
üß† AI –¥—É–º–∞–µ—Ç...
üìã –ù–∞–π–¥–µ–Ω JS –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
15 * 27
‚ö° –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è JS –∫–æ–¥...
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
405

The result of 15 * 27 is 405.
```

### Code Generation Bot

```typescript
// User: "Create a React component for a button"
üß† AI –¥—É–º–∞–µ—Ç...

Here's a simple React button component:

```tsx
interface ButtonProps {
  children: React.ReactNode;
  onClick: () => void;
  variant?: 'primary' | 'secondary';
}

export const Button: React.FC<ButtonProps> = ({ 
  children, 
  onClick, 
  variant = 'primary' 
}) => {
  return (
    <button 
      className={`btn btn-${variant}`}
      onClick={onClick}
    >
      {children}
    </button>
  );
};
```

This component accepts children, click handler, and optional variant.
```